---
title: Individualized risk trajectories for iron-related adverse outcomes in repeat blood donors
author: 


output: 
  officedown::rdocx_document:
    mapstyles:
      Normal: ['First Paragraph']
    reference_docx: word-style-reference-manuscript.docx
bibliography: tailored_idi.bib
csl: american-medical-association-brackets.csl

header-includes:
- \usepackage{placeins}
- \usepackage{amsfonts} 
- \usepackage{amsmath}
---

\newcommand{\1}{\textbf{1}}

<br>

W. Alton Russell^1,2^, David Schienker^1,3,4,5^, Brian Custer^2,6^

<br>

^1^Department of Management Science and Engineering, Stanford University Stanford, CA

^2^Epidemiology and Health Policy Science, Vitalant Research Institute, San Francisco, CA

^3^Lucile Packard Children's Hospital Stanford, Palo Alto, CA, USA

^4^Pediatric Endocrinology, Stanford School of Medicine, Palo Alto, CA, USA

^5^Clinical Excellence Research Center, Stanford School of Medicine, Palo Alto, CA, USA

^6^Department of Laboratory Medicine, University of California, San Francisco, CA

<br>

**Corresponding author:** W. Alton Russell, Management Science and Engineering, Stanford University, Stanford CA 94305. email: [altonr\@stanford.edu](mailto:altonr@stanford.edu){.email}.

**Key words:**

**Running title:**

##### 

```{r setup, include=FALSE}
library(ggplot2)
library(data.table)
library(scales)
library(flextable)
library(officedown)
library(officer)
library(readxl)
theme_set(theme_bw())
knitr::opts_chunk$set(echo = FALSE)

```

# Abstract

**Background:**

**Methods:**

**Results:**

**Conclusions:**

##### 

# Introduction

> Repeat blood donation can cause or exacerbate iron deficiency, with higher incidence among teen donors and premenopausal women [@Cable2012; @Salvin2014; @Spencer2019; @Baart2013; @Rigas2014; @Patel2019]. In the United States, potential donors are screened using fingerstick hemoglobin or hematocrit tests and deferred if levels are below a minimum cutoff. Such low hemoglobin deferrals prevent some collections from iron deficient donors but consume time and resources from both donor and blood center, decreasing donor satisfaction and the likelihood of returning for future donations [@Custer2007]. Because fingerstick hemoglobin is an unreliable indicator of true iron stores, many donors qualify to donate despite having low or absent underlying iron stores [@Baart2013]. More reliable measures of iron status include ferritin, zinc protoporphyrin, soluble transferrin receptor, and hepcidin, but these are more costly to measure and not available as point of care tests [@Kiss2018]. Past studies have identified several factors that increase risk of iron deficiency among blood donors. The Danish Blood Donor Study found that sex, menopause status, and donation history were the strongest predictors of iron deficiency among donors, and weight, age, vitamin use, and diet were also significant [@Rigas2014]. Similar results have been found for donors in the United States, Australia, and the Netherlands [@Cable2012; @Salvin2014; @Spencer2019; @Baart2013; @Patel2019]. Other studies have analyzed predictors for a low hemoglobin deferral for repeat blood donors, identifying age, time since last donation, and donation history as strong predictors [@Baart2011; @Baart2012]. To our knowledge, no prediction model has been developed that considers the competing risks of hemoglobin deferral and of collecting blood from a donor with sufficient hemoglobin but low or absent underlying iron stores.

> In this study, we developed machine learning models to estimate how risk of hemoglobin deferral and completed donations from donors with low or absent iron stores develop as a function of the donation interval -- the length of time from an index donation until the donor returns for a subsequent donation attempt -- in a cohort of donors from the REDS-II Iron Status Evaluation (RISE) study [@Cable2016]. We also compared predictive performance with and without ferritin and soluble transferritin receptor (STfR), two biomarkers that were available for many donations in the RISE study but are not routinely collected by most US blood centers.

<br>

# Methods

> Using data from the RISE study, we trained multiclass prediction models to predict the risk of three iron-related adverse outcomes at a subsequent donation attempt: hemoglobin deferral and donating with low or absent iron stores as defined using ferritin. We assessed the models' predictive performance, compared performance with and without the inclusion of two non-routine biomarkers (ferritin and STfR) as features for prediction, and generated and analyzed individual risk profiles for each donor's likelihood of iron-related adverse donation outcomes at their next visit as a function of their donation interval (how long until the donor returns).

## Data preprocessing and formatting

> The RISE dataset contains data from several U.S. blood centers on donation attempts for 2,425 donors over a 2-year period [@Cable2016]. Data elements include past donation history, biometrics for each visit, and questionnaire responses regarding demographics, diet, supplemental iron consumption, female reproductive health, and demographics from a baseline and final visit. We used 46 variables available for donations in the RISE dataset together with the time until the donor returns to predict the outcome of a follow-up donation attempt. We assumed that donor characteristics measured at the baseline visit such as diet, vitamin use, smoking, and female reproductive health would not change significantly over the study period, and we used them to predict outcomes following subsequent donations by the same donor. We re-coded or imputed missing values for some fields; `r run_reference("t-feature-engineering")` contains these details for all features used for prediction. We also included a composite dietary iron consumption score that was generated for each donor in the RISE dataset as part of previous secondary analysis of this dataset [@Spencer2019a].

> To generate the model development dataset, we considered donations with at least 150 mL of red blood cell loss as potential index donations, which included whole blood donations, apheresis red blood cell donations, and some donations that were classified as 'quantity not sufficient'. We excluded potential index donations that were double red cell donations, that were missing a measurement of ferritin, and donations for which neither fingerstick hemoglobin nor hematocrit was recorded. If follow-up visits were recorded after potential index donations, we generated labels with the time until the follow-up visit (in days) and its outcome. For all index donations followed by a visit with significant iron loss, defined as a loss of at least 55 mL of red blood cells, we generated a label for the index donation based on the first such follow-up visit. We also generated labels for each index donation based on any follow-up visits that did not result in significant iron loss (i.e., visits resulting in a deferral or apheresis donations of platelets or plasma with \<55 mL of red blood cell loss) if such visits occurred before any follow-up visits with significant iron loss. For each index donation $i$, the outcome of its follow-up visits ($z_i$) was classified as hemoglobin deferral ($z_i=1$) if one were recorded; as a low iron donation ($z_i=2$) if pre-donation ferritin was $\geq12$ mg/dl and $<20$ mg/dl for women or $\geq12$ mg/dl and $<30$ mg/dl for men; as an absent iron donation ($z_i=3$) if pre-donation ferritin was \<12 mg/dl; and as a 'no adverse outcome' donation otherwise ($z_i=0$). Follow-up donations without ferritin measurements ($z_i=-1$) were not included in the model development dataset but were included in the 'first return' dataset. We used this dataset for calibrating the model and generating risk trajectories as described below.

## Prediction model development

### Model selection

> We evaluated several candidate model types: gradient boosted machines, random forest, regression trees, and generalized linear models with elastic net regularization with and without second order interaction terms. For each model type we evaluated multiple hyperparameter settings via grid search; the specific hyperparameter combinations assessed are described in `r run_reference("t-mod-tuning")`. We implemented a nested cross validation procedure with resampling to minimize bias in model selection and assessment [@Varma2006]. For this procedure, we generated 15 *model assessment partitions* which consisted of 3 resamples of 5 equal-sized partitions of the entire dataset that were generated with stratified sampling to ensure the distribution of outcomes was balanced across partitions. For each model assessment partition, we defined all data not included in the partition as the corresponding *model tuning set*. Within the 15 tuning sets, we assessed all candidate model configurations (model type and hyperparameter setting) using 5-fold validation, assessing the multiclass area under the reliever operator characteristic curve (multiclass AUC) using the Hand and Till method [@Hand2001]. We compared model configurations based on the average multiclass AUC across 5 cross validation folds averaged over all 15 tuning sets (assessing a total of 75 realizations of each candidate model configuration).

> We also considered ensemble models, which combine the risk scores from multiple base models. We assessed two methods of combining risk scores from base models: a simple average and a weighted average, for which we weighted each model's score proportionally to its accuracy raised to a power of four as suggested by Large et. al. [@Large2019]. We assessed AUC for each candidate ensemble configuration across the same 5 cross validation folds within each of the 15 tuning sets.

> We selected the top model configuration based on multiclass AUC. To produce an unbiased assessment of the selected model configuration, we then assessed multiclass AUC on each of the 15 model assessment partitions. For each assessment partition, we trained the model configuration on all data not in the partition and used this model to generate risk scores on the assessment partition. We then calculated multiclass AUC for the partition.

> To assess impact of measuring ferritin and STfR on ability to predict iron-related adverse outcomes at follow-up donation attempts, we repeated this model development process twice. In the "extra biomarkers" model, we used ferritin and soluble transferrin receptor and derived measures (log ferritin, ratio of STfR to log ferritin, and calculated body iron) as features for prediciton. Because these biomarkers are not routinely measured for most blood donations in the United States, we also developed a "standard biomarkers" version that excluded these features.

### Feature importance

> For the selected "standard" and "extra biomarkers" model configurations, we assessed the importance of features for prediction using a random permutation method [@Breiman2001]. In this procedure we randomly shuffled one feature collumn in each model assessment partition and generating risk scores using the model trained on all data not in that partition. We calculated the percent decrease in multiclass AUC when a feature's column was shuffled as compared to the unaltered dataset as a measure of the feature's importance to the model.

### Calibration

> To generate the final model, we retrained the selected model configurations on the entire model development dataset and then calibrated the predicted probabilities to a 'first return' dataset, wherein index donations were labled only once with the outcome of the first subsequent donation attempt. The first return dataset included completed donations with no ferritin measurement; we estimated the distribution of outcomes for follow-up visits from the first return dataset by assuming that the distribution of absent, low, and 'no-adverse outcome' donations in follow-up donations at which ferritin was not measured would be the same as for those with ferritin measured. Mathematically, we totaled each follow-up outcome as $n^{(k)}$, where $k=-1, 0, 1, 2, 3$ correspond to the outcomes described above. We then calculated $\tilde{n}^{(k)}$, an estimation of what the totals would have been if ferritin were measured for all follow-up donations, as $\tilde{n}^{(1)} = n^{(1)}$ (hemoglobin deferral) and $\tilde{n}^{(l)} = n^{(l)}+n^{(-1)}\frac{n^{(l)}}{n^{(0)}+n^{(2)}+n^{(3)}}$ for $l=0,2,3$ (completed donations). We then used our top model to generate the unnormalized probability vector $[\hat{q}_i^{(0)}, \hat{q}_i^{(1)}, \hat{q}_i^{(2)}, \hat{q}_i^{(3)}]$ for each index donation $i$. We computed weights $w^{(k)}$ for the unnormalized probability of each outcome $\hat{q}_i^{(k)}$ by solving the system of equations $\sum_{i=1}^I w^{(k)}\hat{q}_i^{(k)}/\sum_{\tilde{k}=0}^4 w^{(\tilde{k})}\hat{q}_i^{(\tilde{k})} = \tilde{n}^{(k)}$ for $k=0,1,2,3$. The final calibrated model used parameters $a^{(k)}$, $b^{(k)}$, and $w^{(k)}$ together with the uncalibrated scores from the model $z_i^{(k)}$ to produce the estimated likelihood of each outcome at a follow-up donation as $\tilde{q}^{(k)}=w^{(k)}\hat{q}^{(k)}/\sum_{\tilde{k}=1}^4 w^{(\tilde{k})}\hat{q}_j^{(\tilde{k})}$ where $\hat{q}_i^{(k)} = \sigma (a^{(k)} z_i^{(k)} + b^{(k)})$. This ensured that the expectation of the distribution of the predicted outcome for the first return dataset would correspond to our estimated totals $\tilde{n}^{(k)}$.

# Risk trajectory analysis

> For each index donation, we generated a risk trajectory by predicting the likelihood of each outcome at the donor's next donation attempt for each possible followup donation interval between 56 and 256 days using the calibrated 'extra biomarkers' model. We generated graphical representations of individual donors' risk trajectories showing how the estimated of each adverse outcome evolve if donors wait longer to return. In subgroup analysis, we compared the mean and 95% confidence interval for the estimated risk of each adverse event for each donation interval from 56 to 250 days for groups of donors stratified by key parameters.

<br>

# Results

## Data processing

```{r echo=FALSE, include=FALSE}
dt.md <- fread( "../1_data/model_dev_data/ml_training_data.csv")
dt.firstreturn <- fread("../1_data/first_return_dataset.csv")

add_footnotes <- function(ft, notes){
  
  for (idx_note in 1:length(notes)){
    note =  notes[[idx_note]]
    if (is.na(note[[2]])){
      col <- colnames(ft$body$dataset)[1]
      ft <- compose(ft, i= note[[1]], 
                  part = note[[3]],
                  value = as_paragraph(get(col), as_sup(as.character(idx_note))) )
      
      ft <- merge_h(ft, i = note[[1]])
      
    } else {
      col = ft$col_keys[note[[2]]]
      
      ft <- compose(ft, i= note[[1]], 
                  j = note[[2]], 
                  part = note[[3]],
                  value = as_paragraph(get(col), as_sup(as.character(idx_note))) )
    }
    
  }
  
  
  ft <- compose(ft,
                i = nrow(ft$body$dataset),
                part = "body",
                value = as_paragraph(paste(paste0(1:length(notes), ". ", unlist(sapply(notes, `[`, 4))), collapse='\n')))
  ft <- merge_h(ft, i = nrow(ft$body$dataset), part="body")
  # ft <- italic(ft, i = nrow(ft$body$dataset),
  #               j=1,
  #               part = "body")
  ft <- color(ft, i = nrow(ft$body$dataset),
                j=1,
              color = "#696969",
                part = "body")
  
  #ft <- merge_h(ft, i = nrow(ft$body$dataset), part="body")
  
  return(ft)
}

flextable_with_foot <- function(dt, notes, group = NA){
  
  if (!is.na(group)){
    
    # dt <- data.table(as_grouped_data(data.table(df),
    #                                           groups = "Setting"))
    # dt <- rbind(dt,
    #             matrix(NA, ncol = ncol(dt)),
    #                       use.names = FALSE)
    # ft <- flextable(dt)
    dt <- data.table(as_grouped_data(data.table(dt),
                                              groups = group))
    
    dt <- rbind(dt,
                matrix(NA, ncol = ncol(dt)),
                          use.names = FALSE)
    ft <- flextable(dt,
                    col_keys = colnames(dt)[-1])
    ft <- compose(ft, i = ~ !is.na(get(group)),
              value = as_paragraph(get(group)))
    ft <- add_footnotes(ft, notes)
    
    ft <- merge_h(ft, i = !is.na(ft$body$dataset[,1]))
    
  } else {
    ft <- flextable(rbind(data.table(dt),
                          matrix("blank", ncol = ncol(dt)),
                          use.names = FALSE))
    ft <- add_footnotes(ft, notes)
  }
  
  
  ft <- fontsize(ft, size = 8, part = "all")
  ft <- align(ft, align = "left", part = "all")
  ft <- bg(ft, bg = "#EAEAEA", part = "header")
  ft <- theme_box(ft)
  
  return(ft)
}




dt.md[ , donation_id := paste0(RandID, "-V", VisitNum)]
tbl_labels_per_idx <- table(dt.md[ , .N, by = donation_id]$N)

```

> In the RISE dataset, a total of `r nrow(dt.firstreturn)` donations from `r dt.firstreturn[, uniqueN(RandID)]` donors were followed by at least one follow-up visit. We removed `r dt.firstreturn[is.na(FingerstickHGB_equiv), .N]` index donations because hemoglobin was not recorded, and we removed a further `r dt.firstreturn[time_to_fu < 56, .N]` index donations from the first return dataset because the first follow-up visit with significant iron loss was less than 56 days later. The first return dataset contained `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56, .N]` index donations labeled with the outcome of the first follow-up donation. That outcome was a hemoglobin deferral for `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56 & fu_outcome == 1, .N]` index donations; a low-iron donation for `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56 & fu_outcome == 2, .N]`; an absent iron donation for `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56 & fu_outcome == 3, .N]`; no adverse outcome for `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56 & fu_outcome == 0, .N]`; and a completed donation with unknown iron status for `r dt.firstreturn[!is.na(FingerstickHGB_equiv) & time_to_fu >= 56 & fu_outcome == -1, .N]`. The model development dataset included `r dt.md[ , uniqueN(donation_id)]` unique index donations from `r dt.md[ , uniqueN(RandID)]` donors. `r tbl_labels_per_idx[[1]]` index donations were labeled with one follow-up donation, `r tbl_labels_per_idx[[2]]` were labeled twice, and `r dt.md[ , uniqueN(donation_id)] - tbl_labels_per_idx[[1]] - tbl_labels_per_idx[[2]]` were labeled with 3 or more follow-up visit outcomes (maximum of 8).

## Prediction model

> We evaluated over 2,000 model configurations (model type and hyperparameter settings) across the five candidate model types. `r run_reference("f-tuning-auc")` shows the average overall AUC within the 15 tuning datasets for each model configuration, and `run_reference("t-mod-tuning")` shows the top hyperparameter setting for each model type. The top "standard biomarkers" model configuration was an ensemble model that averaged risk scores for three gradient boosted machine and three random forest models, with an AUC of XXX. The top "extra biomarkers" model was an ensemble model that averaged risk scores for two gradient boosted machines, a random forest model, and two penalized regression models, one with second order interaction terms (multiclass AUC ). `r run_reference("f-ensemble-auc")` shows the multiclass AUC for the top ensemble configurations and base models. For both models, discriminative performance was highest for predicting no adverse outcome donations and lowest for predicting low iron donations. In a secondary analysis, we found that use of ferritin, soluble transferrin receptor, and body iron increased the overall AUC from 77% to 82% among the subset of donations for which those values were recorded. Inclusion of these biomarkers increased discriminative performance most substantially for identifying absent iron donations and had little effect on ability to discriminate hemoglobin deferrals.

> Variable importance for the top model in the primary analysis is shown in `r run_reference("f-var-imp-XB")` and for the model using extra biomarkers as predicters in `r run_reference("f-var-imp-noXB")`. In the primary analysis, hemoglobin and return time were most important for predicting the outcome of a follow-up donation. When additional biomarkers were used as predictors, ferritin became the most important.

> We calculated normalization weights to calibrate the model scores to the expected distribution of outcomes in the first return dataset. They were 1.4 for the probability of no adverse outcome; 0.47 for the probability of a hemoglobin deferral; 1.1 for the probability of a low iron donation; and 1.2 for the probability of an absent iron donation.

## Individual risk profiles

> Figure shows the individual risk trajectories from two donations: one for a donor whose risk of an adverse outcome was high at day 56 but declined over time and another for a donor who had a low risk of adverse outcomes even at day 56. `r run_reference("f-sixty-trajectories")` shows the same plots for 60 randomly selected index donations from the first return dataset. Notably, estimated risk did not monotonically decrease for all adverse events for all donors. For example, the risk of a low iron donation increased as risk of hemoglobin deferral or an absent iron donation fell for some donors.

> Figure shows the probability of any adverse outcome at post-donation day 56 and post-donation day 250. The median risk of any adverse outcome at day 56 was 71% (IQR 43% -- 86%), but this dropped to 23% (IQR 12% -- 41%) at post-donation day 250. While risk of an adverse outcome fell for most donors, some continued to have a high risk even at post-donation day 250. For 787 donors (11%), estimated risk of any adverse outcome was above 60% at post-donation day 250, which may indicate an underlying iron-related condition unrelated to repeat blood donation.

> `r run_reference("f-ae-trajectory-examples")` shows different trajectory types.

> `r run_reference("f-traject-by-iron-status")` is by iron status.

> `r run_reference("f-traject-by-venous-hgb")` is by tertile of venous hemoglobin.

> `r run_reference("f-traject-by-gender")` shows different gender.

> `r run_reference("f-traject-by-RBC-loss")` shows tertiles of red blood cells lost.

> `r run_reference("f-traject-iron_supplementation")` shows whether people take daily iron supplementation.

> `r run_reference("f-traject-composite_iron")` shows tertiles of the composite iron scores.

# Discussion

> Risk of iron-related adverse outcomes at follow-up donations can be estimated as a function of the return time using data available at an index donation. Estimated risk decreased precipitously for most donors if they waited longer to return, suggesting that tailoring donors' IDIs to individual donors' risk profiles may be an effective strategy for managing risk of iron-related adverse donation outcomes without unduly restricting return donations from low-risk donors. Risk for some donors remained high even 250 days later, suggesting that these methods could also be used to identify individuals who may be poor candidates for repeat blood donation due to underlying iron deficiency. Including ferritin as a predictor improved risk estimation, particularly with respect to estimating risk of absent iron donations.

> Our analysis has several limitations. The RISE study asked participants to commit to frequent blood donation and targeted recruitment to achieve proportional representation based on gender and donation history [@Cable2011]. Further study is needed to assess the generalizability of our prediction model's performance to a general blood donor population. Additionally, the outcomes we estimated at the population level are specific to the RISE cohort. In particular, the baseline rate of adverse outcomes and the reduction in supply introduced by tailored IDIs may be lower in populations with lower return rates. Another limitation of the RISE data is that ferritin and other biomarkers were not measured for all follow-up visits. We factored this into our analysis by assuming these biomarkers were missing at random, but this may not be the case.

> Two other limitations must be overcome before tailored IDIs can be implemented in practice. First, a decision-maker must identify risk thresholds for each adverse outcome in our method. Experts may not agree on the level of risk that is acceptable and how the sufficiency of the blood supply should be weighed against risks to donors. Further work is needed to understand these trade-offs and identify reasonable risk thresholds. Second, this method may face significant barriers to implementation. Sophisticated machine learning techniques for decision-making require technical expertise to develop and maintain and are opaque in the sense that humans cannot readily understand how the system arrived at a decision. In a growing literature on interpretable machine learning, methods have been developed for constructing simpler decision rules that sometimes perform on par with advanced machine learning techniques [@Jung2017; @Ustun2016; @Letham2015; @Lakkaraju2016; @Ustun2019]. Further work is needed to assess barriers to the adoption of the tailored IDI method developed here and to determine whether simpler decision rules might be easier to implement and perform similarly. Despite these limitations, our analysis suggests that individual risk prediction could be a useful tool for ensuring a sufficient blood supply while managing iron-related risks to repeat blood donors.

##### 

# Declarations

**Funding:** A

**Conflicts:** A

**Ethics/Consent:** A

**Data and materials:** A

**Code availability:** A

**Authors' contributions:**

##### 

# References

::: {#refs}
:::

##### 

# Figures

```{r fig.width=6.5, fig.height=3.5}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-roc-compare",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ROC_compare.png")

block_caption("One vs. all ROC curves with and without ferritin, soluble transferrin receptor, and derived measures. Black dot at 75% sensitivity and 75% specificity for visual reference.", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

```{r fig.width=5, fig.height=6}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-var-imp-noXB",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/feat_imp_noXB.png")

block_caption("Relative variable importance for the top \"standard biomarkers\" model.", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

```{r fig.width=5, fig.height=6}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-var-imp-XB",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/feat_imp_XB.png")

block_caption("Relative variable importance for the top \"extra biomarkers\" model.", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

```{r fig.width=6, fig.height=5}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-ae-trajectory-examples",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/each_ae_traject.png")

block_caption("Risk trajectory for any adverse event (top) or a specific adverse event (bottom) for 100 randomly-selected donors. Five 'chronic high risk' donors with more than 80% risk of an adverse event if they return on post-donation day 250 are shown in red; five 'quick recoverer' donors with less than 5% risk of an adverse event if they return on post-donation day 56 shown in green; and 5 'slow recoverer' donors whose risk of an adverse event was above 60% on post-donation day 56 but fell below 35% by postdonation day 250.", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

```{r fig.width=5, fig.height=5}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-traject-by-iron-status",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_Index_donation_iron_status.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

```{r fig.width=5, fig.height=5}
fig_num <- run_autonum(seq_id = "fig",
                       pre_label = "Figure ",
                       bkm="f-traject-by-venous-hgb",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_Venous_HGB_tertile.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = fig_num)
```

##### 

# Tables

```{r, echo=FALSE}
tab_num <- run_autonum(seq_id = "tab", 
                       pre_label = "Table ", 
                       bkm="t-model-aucs",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

t_model_aucs <- as_flextable(as_grouped_data(read_excel("../1_data/tables.xlsx", sheet = "features"),
                                              groups = "Category"))
t_model_aucs <- compose(t_model_aucs, i = ~ !is.na(Category), j = "Variable name",
              value = as_paragraph(as_chunk(Category)))
t_model_aucs <- align(t_model_aucs, align = "left", part = "all")
t_model_aucs <- fontsize(t_model_aucs, size = 10, part = "all")
t_model_aucs <- font(t_model_aucs, fontname = "Times", part = "all")
t_model_aucs <- theme_box(t_model_aucs)
t_model_aucs <- bg(t_model_aucs, bg = "#EAEAEA", part = "header")
t_model_aucs <- width(t_model_aucs, 1, 1.6)
t_model_aucs <- width(t_model_aucs, 2, 2.1)
t_model_aucs <- width(t_model_aucs, 3, 2.8)
t_model_aucs <- bg(t_model_aucs, i = c(1, 10, 21, 45), bg = "#DDDDDD", part = "body")
t_model_aucs <- bold(t_model_aucs, i = c(1, 10, 21, 45), part = "body")
t_model_aucs <- set_caption(t_model_aucs, 
                                     "Multiclass and one verses rest AUC by outcome for the top ``standard`` and ``extra biomarker`` model configuration as assessed in the outer cross validation loop.",
                                     autonum = tab_num)

t_model_aucs
```

##### 

\setcounter{page}{0}

# Supplemental materials

<br>

# A. Calculations for estimating the outcomes of pathogen inactivation

Blank.

##### 

# Supplemental tables

```{r, echo=FALSE}
stab_num <- run_autonum(seq_id = "stab", 
                       pre_label = "Table S", 
                       bkm="t-feature-engineering",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

t_feature_engineering <- as_flextable(as_grouped_data(read_excel("../1_data/tables.xlsx", sheet = "features"),
                                              groups = "Category"))
t_feature_engineering <- compose(t_feature_engineering, i = ~ !is.na(Category), j = "Variable name",
              value = as_paragraph(as_chunk(Category)))
t_feature_engineering <- align(t_feature_engineering, align = "left", part = "all")
t_feature_engineering <- fontsize(t_feature_engineering, size = 10, part = "all")
t_feature_engineering <- font(t_feature_engineering, fontname = "Times", part = "all")
t_feature_engineering <- theme_box(t_feature_engineering)
t_feature_engineering <- bg(t_feature_engineering, bg = "#EAEAEA", part = "header")
t_feature_engineering <- width(t_feature_engineering, 1, 1.6)
t_feature_engineering <- width(t_feature_engineering, 2, 2.1)
t_feature_engineering <- width(t_feature_engineering, 3, 2.8)
t_feature_engineering <- bg(t_feature_engineering, i = c(1, 10, 21, 45), bg = "#DDDDDD", part = "body")
t_feature_engineering <- bold(t_feature_engineering, i = c(1, 10, 21, 45), part = "body")
t_feature_engineering <- set_caption(t_feature_engineering, 
                                     "List of features for prediction model with description and notes from feature engineering.",
                                     autonum = stab_num)
# t_feature_engineering <- footnote(t_feature_engineering, i=1, j=1, part="header",ref_symbols ="1",
#                          value=as_paragraph("FFP = fresh or frozen plasma; GBS = Guillain–Barré syndrome; ID-NAT = individual donation nucleic acid testing; IND = investigational new drug; KLT = known local transmission; MP-NAT = mini-pooled NAT; PLT = platelet; PSA = probabilistic sensitivity analysis; RBC = red blood cell; TT = transfusion transmission; ZIKV = Zika virus."))

t_feature_engineering
```

##### 

```{r echo=FALSE}
stab_num <- run_autonum(seq_id = "stab", 
                       pre_label = "Table S", 
                       bkm="t-mod-tuning",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

t_mod_tuning <- as_flextable(as_grouped_data(read_excel("../1_data/tables.xlsx", sheet = "mod_tuning"),
                                              groups = "Model"))
t_mod_tuning <- compose(t_mod_tuning, i = ~ !is.na(Model), j = "Hyperparameters",
              value = as_paragraph(as_chunk(Model)))
#t_mod_tuning <- set_caption(t_mod_tuning, caption = 'List of features for prediction model with description and notes from feature engineering.')
t_mod_tuning <- align(t_mod_tuning, align = "left", part = "all")
t_mod_tuning <- fontsize(t_mod_tuning, size = 8, part = "all")
t_mod_tuning <- bg(t_mod_tuning, bg = "#EAEAEA", part = "header")
t_mod_tuning <- width(t_mod_tuning, 1, 1.5)
t_mod_tuning <- width(t_mod_tuning, 2, 2)
t_mod_tuning <- width(t_mod_tuning, 3, 1.3)
t_mod_tuning <- width(t_mod_tuning, 4, 1.3)
t_mod_tuning <- bg(t_mod_tuning, i = c(1, 7, 11, 14, 17), bg = "#DDDDDD", part = "body")
t_mod_tuning <- bold(t_mod_tuning, i = c(1, 7, 11, 14, 17), part = "body")
t_mod_tuning <- merge_v(t_mod_tuning, j=5, part="body")
t_mod_tuning <- set_caption(t_mod_tuning, "Model types and hyperparameters assessed as candidates. All hyperparameter combinations were assessed in 5-fold cross validation on each of 15 model validation sets defined by the nested cross validation scheme.")
t_mod_tuning <- theme_box(t_mod_tuning)
t_mod_tuning <- set_caption(t_mod_tuning, 
                                     "List of features for prediction model with description and notes from feature engineering.",
                                     autonum = stab_num)
t_mod_tuning
```

##### 

# Supplemental figures

```{r fig.width=6, fig.height=5.5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-tuning-auc",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))
knitr::include_graphics("../4_output/figs/AUC_tuning_no_ensemble.png")

block_caption("Average multiclass AUC for each evaluated model configuration as assessed using 5-fold cross validation and averaged across 15 tuning sets (excluding ensemble models). Each configuration (model type and hyperparameter set) is plotted as a dot. Distributions for each model type are shown.", 
              style = "Image Caption", 
              autonum = sfig_num)

```

##### 

# Supplemental figures

```{r fig.width=6, fig.height=5.5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-ensemble-auc",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))
knitr::include_graphics("../4_output/figs/AUC_tuning_no_ensemble.png")

block_caption("Distribution of multiclass AUC for across the 15 tuning sets for the top ensemble model configurations and the base model configurations that comprised them. For both the ``standard`` and ``extra biomarkers`` versions, the top ensemble was an average of the base models.", 
              style = "Image Caption", 
              autonum = sfig_num)

```

##### 

```{r fig.width=6.5, fig.height = 8}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-sixty-trajectories",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/trajectories_60_random.png")

block_caption("Individual risk trajectory for sixty randomly-selected index donations.", 
              style = "Image Caption", 
              autonum = sfig_num)
```

##### 

```{r fig.width=5, fig.height=5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-traject-by-gender",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_Gender.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = sfig_num)
```

##### 

```{r fig.width=5, fig.height=5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-traject-by-RBC-loss",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_RBC_units_lost_prior_24_months_tertile.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = sfig_num)
```

##### 

```{r fig.width=5, fig.height=5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-traject-iron_supplementation",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_Iron_supplementation.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = sfig_num)
```

##### 

```{r fig.width=5, fig.height=5}
sfig_num <- run_autonum(seq_id = "sfig",
                       pre_label = "Figure S",
                       bkm="f-traject-composite_iron",
                       bkm_all = TRUE,
                       prop = fp_text(bold=TRUE, underlined = TRUE))

knitr::include_graphics("../4_output/figs/ae_traject_by_Composite_iron_tertile.png")

block_caption(".", 
              style = "Image Caption", 
              autonum = sfig_num)
```
